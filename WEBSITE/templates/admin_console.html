{% extends "base.html" %}

{% block title %}Admin Console{% endblock %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center mb-4">Admin Console</h2>

    <div class="card mb-4">
        <h4 class="mb-3">User Management</h4>
        <div class="scroll-box" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-bordered table-hover">
                <thead>
                    <tr>
                        <th style="color: white;">Display Name</th>
                        <th style="color: white;">Username</th>
                        <th style="color: white;">Role</th>
                        <th style="color: white;">Promote</th>
                        <th style="color: white;">Delete</th>
                        <th style="color: white;">Add Funds</th>
                        <th style="color: white;">Subtract Funds</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td style="color: white;">{{ user.display_name }}</td>
                        <td style="color: white;">{{ user.username }}</td>
                        <td style="color: white;">{{ user.role }}</td>

                        <td>
                            {% if user.id != session['user_id'] %}
                                {% if user.role == 'admin' %}
                                    <form method="POST" action="{{ url_for('demote_user', user_id=user.id) }}">
                                        <button type="submit" class="btn btn-sm btn-warning">Demote</button>
                                    </form>
                                {% else %}
                                    <form method="POST" action="{{ url_for('promote_user', user_id=user.id) }}">
                                        <button type="submit" class="btn btn-sm btn-success">Promote</button>
                                    </form>
                                {% endif %}
                            {% endif %}
                        </td>

                        <td>
                            <form method="POST" action="{{ url_for('delete_user', user_id=user.id) }}" onsubmit="return confirm('Delete this user?');">
                                <button type="submit" class="btn btn-sm btn-danger">Delete</button>
                            </form>
                        </td>

                        <td>
                            <form method="POST" action="{{ url_for('add_funds_user', user_id=user.id) }}" class="d-flex gap-1">
                                <input name="amount" placeholder="$" class="form-control form-control-sm" required type="number" step="0.01">
                                <button class="btn btn-sm btn-success">Add</button>
                            </form>
                        </td>

                        <td>
                            <form method="POST" action="{{ url_for('subtract_funds_user', user_id=user.id) }}" class="d-flex gap-1">
                                <input name="amount" placeholder="$" class="form-control form-control-sm" required type="number" step="0.01">
                                <button class="btn btn-sm btn-warning">Sub</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    <div class="card mb-4">
        <h4 class="mb-3">Manage Stocks</h4>

        <!-- Mode Switch Buttons -->
        <div class="btn-group mb-3">
            <button class="btn btn-primary" onclick="setStockMode('add')">Add</button>
            <button class="btn btn-warning" onclick="setStockMode('modify')">Modify</button>
            <button class="btn btn-danger" onclick="setStockMode('remove')">Remove</button>
        </div>

        <!-- ADD STOCK PANEL -->
        <div id="stock-add" class="stock-panel">
            <form method="POST" action="{{ url_for('add_stock_route') }}">
                <div class="mb-2">
                    <label>Stock Name</label>
                    <input type="text" name="stock_name" class="form-control" required>
                </div>

                <div class="mb-2">
                    <label>Ticker</label>
                    <input type="text" name="ticker" class="form-control" maxlength="10" required>
                </div>

                <div class="mb-2">
                    <label>Quantity</label>
                    <input type="number" name="quantity" class="form-control" min="1" value="1000" required>
                </div>

                <div class="mb-2">
                    <label>Base Price</label>
                    <input type="number" step="0.01" name="base_price" class="form-control" required>
                </div>

                <div class="text-end">
                    <button type="submit" class="btn btn-primary">Add Stock</button>
                </div>
            </form>
        </div>

        <!-- REMOVE STOCK PANEL -->
        <div id="stock-remove" class="stock-panel d-none">
            <form method="POST" action="{{ url_for('remove_stock') }}">
                <div class="mb-2">
                    <label>Select Stock</label>
                    <select name="stock_id" class="form-control" required>
                        <option value="">-- Choose Stock --</option>
                        {% for s in stocks %}
                            <option value="{{ s.stockId }}">
                                {{ s.name }} ({{ s.ticker }})
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <div class="text-end">
                    <button type="submit" class="btn btn-danger" onclick="return confirm('Delete this stock?');">Remove Stock</button>
                </div>
            </form>
        </div>

        <!-- MODIFY STOCK PANEL -->

        <div id="stock-modify" class="stock-panel d-none">

            <div class="mb-2">
                <label>Select Stock</label>
                <select id="modify-stock-selector" class="form-control">
                    <option value="">-- Choose Stock --</option>
                    {% for s in stocks %}
                        <option value="{{ s.stockId }}">{{ s.name }} ({{ s.ticker }})</option>
                    {% endfor %}
                </select>
            </div>

        <form id="modify-stock-form"
            method="POST"
            action="{{ url_for('modify_stock_route', stock_id=0) }}">
            
            <div class="mb-2">
                <label>Stock Name</label>
                <input id="mod-name" type="text" name="stock_name" class="form-control" required>
            </div>

            <div class="mb-2">
                <label>Ticker</label>
                <input id="mod-ticker" type="text" name="ticker" maxlength="10" class="form-control" required>
            </div>

            <div class="mb-2">
                <label>Quantity</label>
                <input id="mod-qty" type="number" name="quantity" min="1" class="form-control" required>
            </div>

            <div class="mb-2">
                <label>Base Price</label>
                <input id="mod-base" type="number" step="0.01" name="base_price" class="form-control" required>
            </div>

            <div class="text-end">
                <button type="submit" class="btn btn-warning">Update Stock</button>
            </div>
        </form>
    </div>
    
    <div class="col-md-12 mt-4">
        <h4>All Orders</h4>
        <div class="scroll-box">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th style="color: white;">Order ID</th>
                        <th style="color: white;">User</th>
                        <th style="color: white;">Stock</th>
                        <th style="color: white;">Action</th>
                        <th style="color: white;">Quantity</th>
                        <th style="color: white;">Total</th>
                        <th style="color: white;">Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    {% for o in orders %}
                        <tr>
                            <td style="color: white;">{{ o.id }}</td>
                            <td style="color: white;">{{ o.user.username }}</td>
                            <td style="color: white;">{{ o.stock.ticker }}</td>
                            <td style="color: white;">{{ o.action }}</td>
                            <td style="color: white;">{{ o.quantity }}</td>
                            <td style="color: white;">${{ "%.2f"|format(o.total_amount) }}</td>
                            <td style="color: white;">{{ o.timestamp }}</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <h4 class="mb-3">Modify Calendar</h4>
    <div class="card mb-4">
        <form action="{{ url_for('calendar_add') }}" method="POST" class="row g-3">
                <div class="col-md-3">
                    <input type="text" name="title" class="form-control" placeholder="Event Title" required>
                </div>
                <div class="col-md-3">
                    <input type="text" name="description" class="form-control" placeholder="Description (optional)">
                </div>
                <div class="col-md-2">
                    <input type="date" name="start_date" class="form-control" required>
                </div>
                <div class="col-md-2">
                    <input type="time" name="start_time" class="form-control" required>
                </div>
                <div class="col-md-2">
                    <input type="date" name="end_date" class="form-control" placeholder="End Date">
                </div>
                <div class="col-md-2">
                    <input type="time" name="end_time" class="form-control" placeholder="End Time">
                </div>
                <div class="col-md-2">
                    <select name="event_type" class="form-control">
                        <option value="event">Event</option>
                        <option value="closed">Closed</option>
                        <option value="custom_hours">Custom Hours</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="time" name="custom_open_time" class="form-control" placeholder="Custom Open Time">
                </div>
                <div class="col-md-2">
                    <input type="time" name="custom_close_time" class="form-control" placeholder="Custom Close Time">
                </div>
                <div class="col-md-1">
                    <button type="submit" class="btn btn-primary w-100">Add Event</button>
                </div>
            </form>
        </div>
    
        <div class="scroll-box" style="max-height: 400px; overflow-y: auto;">
            <table class="table table-bordered">
                <thead>
                    <tr>
                        <th style="color: white;">Title</th>
                        <th style="color: white;">Start</th>
                        <th style="color: white;">End</th>
                        <th style="color: white;">Remove</th>
                    </tr>
                </thead>
                <tbody>
                    {% for evt in calendar_events %}
                    <tr>
                        <td style="color: white;">{{ evt.title }}</td>
                        <td style="color: white;">{{ evt.start_datetime.strftime('%Y-%m-%d %H:%M') }}</td>
                        <td style="color: white;">{{ evt.end_datetime.strftime('%Y-%m-%d %H:%M') if evt.end_datetime else '' }}</td>
                        <td>
                            <form method="POST" action="{{ url_for('calendar_remove', event_id=evt.id) }}" onsubmit="return confirm('Remove event?');">
                                <button class="btn btn-sm btn-danger">Remove</button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Admin Actions Section -->
    <div class="mt-3 text-end">
        <form method="POST" action="{{ url_for('simulate_fast_ticks') }}" style="display:inline;">
            <button type="submit" class="btn btn-primary">Simulate Fast Tick</button>
        </form>
        <form method="POST" action="{{ url_for('compress_end_of_day') }}" style="display:inline;">
            <button class="btn btn-secondary">Compress End of Day</button>
        </form>
    </div>
</div>

<script>
function setStockMode(mode) {
    document.querySelectorAll('.stock-panel').forEach(p => p.classList.add('d-none'));

    if (mode === 'add')
        document.getElementById('stock-add').classList.remove('d-none');
    else if (mode === 'remove')
        document.getElementById('stock-remove').classList.remove('d-none');
    else if (mode === 'modify')
        document.getElementById('stock-modify').classList.remove('d-none');
}
</script>

{% endblock %}
